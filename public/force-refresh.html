<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background: #1a1a1a;
            color: white;
        }
        .container {
            text-align: center;
            padding: 40px;
            background: #2a2a2a;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        h1 {
            margin-bottom: 20px;
            color: #ff6b6b;
        }
        .loading {
            font-size: 48px;
            animation: spin 2s linear infinite;
            display: inline-block;
            margin: 20px 0;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            background: #3a3a3a;
            border-radius: 5px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ä¸­...</h1>
        <div class="loading">ğŸ”„</div>
        <div class="status" id="status">å‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</div>
    </div>

    <script>
        async function forceRefresh() {
            const status = document.getElementById('status');
            
            try {
                // 1. Service Workerã‚’å…¨ã¦è§£é™¤
                status.textContent = 'Service Workerã‚’è§£é™¤ä¸­...';
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(reg => reg.unregister()));
                }
                
                // 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å…¨ã¦ã‚¯ãƒªã‚¢
                status.textContent = 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ä¸­...';
                if ('caches' in window) {
                    const names = await caches.keys();
                    await Promise.all(names.map(name => caches.delete(name)));
                }
                
                // 3. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ï¼ˆèªè¨¼æƒ…å ±ã¯ä¿æŒï¼‰
                status.textContent = 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ä¸­...';
                const token = localStorage.getItem('token');
                const user = localStorage.getItem('user');
                localStorage.clear();
                if (token) localStorage.setItem('token', token);
                if (user) localStorage.setItem('user', user);
                
                // 4. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                sessionStorage.clear();
                
                // 5. ã‚¯ãƒƒã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ‘ã‚¹ã‚’æŒ‡å®šï¼‰
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                });
                
                status.textContent = 'å®Œäº†ï¼ç®¡ç†ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™...';
                
                // 6. å¼·åˆ¶çš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡è¦–ã—ã¦å†èª­ã¿è¾¼ã¿
                setTimeout(() => {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã‚’è¿½åŠ ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    window.location.href = '/admin?nocache=' + Date.now();
                }, 1500);
                
            } catch (error) {
                status.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                console.error(error);
            }
        }
        
        // è‡ªå‹•å®Ÿè¡Œ
        forceRefresh();
    </script>
</body>
</html>